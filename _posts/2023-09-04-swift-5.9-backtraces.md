---
layout: post
published: true
date: 2023-09-04 10:06:17
title: On-crash Backtraces in Swift
author: [al45tair]
---

Up to now, when a Swift program crashes, we've left it up to the
operating system to deal with the fall out.  That means, on Darwin and
Windows systems, the system-wide crash reporter will kick in and
generate a crash log, but on Linux there typically isn't a system-wide
crash reporter so very likely all you get is a message from the parent
process (often the shell) telling you that the child process crashed.

For instance:

```
$ ./crash
I'm going to crash now
zsh: segmentation fault  ./crash
```

This is clearly less than ideal.

In Swift 5.9, this is changing; the runtime is gaining an on-crash
backtracing facility.  This is enabled by default on Linux and can be
enabled on macOS (see later for instructions).

Instead of the opaque message above, when run from a terminal the
result is something like this:

<pre class="terminal" style='color:#fff; background: #000'>
<span class='shell'>$ </span><span class='cmd'>./crash</span>
I&#39;m going to crash now

💣 <span style='color:#f55'>Program crashed: Bad pointer dereference at 0x0000000000000004</span>

Thread 0 crashed:

<span style='color:#555'>0</span> <span style='color:#5ff'>reallyCrashMe()</span><span style='color:#aaa'> + 404</span> in <span style='color:#a0a'>crash</span> at <span style='color:#a60'>/Users/alastair/Source/crashDotSwift/crash.swift:4:15</span>

  <span style='color:#555'>   2</span>│   print(&quot;I&#39;m going to crash now&quot;)
  <span style='color:#555'>   3</span>│   let ptr = UnsafeMutablePointer&lt;Int&gt;(bitPattern: 4)!
  <span style='background:#1c1c1c'><span style='color:#fff'><span
  style='color:#555'>   4<span style='color: #fff'>│   ptr.pointee = 42</span></span></span>                                                    </span>
  <span style='color:#555'>    </span>│               <span style='color:#f55'>▲</span>
  <span style='color:#555'>   5</span>│ }
  <span style='color:#555'>   6</span>│

<span style='color:#555'>1</span> <span style='color:#5ff'>crashMe()</span><span style='color:#aaa'> + 12</span> in <span style='color:#a0a'>crash</span> at <span style='color:#a60'>/Users/alastair/Source/crashDotSwift/crash.swift:8:3</span>

  <span style='color:#555'>   6</span>│ 
  <span style='color:#555'>   7</span>│ func crashMe() {
  <span style='background:#1c1c1c'><span style='color:#fff'><span style='color:#555'>   8<span style='color: #fff'>│   reallyCrashMe()</span></span></span>                                                     </span>
  <span style='color:#555'>    </span>│   <span style='color:#f55'>▲</span>
  <span style='color:#555'>   9</span>│ }
  <span style='color:#555'>  10</span>│

<span style='color:#555'>2</span> <span style='color:#5ff'>main</span><span style='color:#aaa'> + 12</span> in <span style='color:#a0a'>crash</span> at <span style='color:#a60'>/Users/alastair/Source/crashDotSwift/crash.swift:11:1</span>

  <span style='color:#555'>   9</span>│ }
  <span style='color:#555'>  10</span>│ 
  <span style='background:#1c1c1c'><span style='color:#fff'><span style='color:#555'>  11<span style='color: #fff'>│ crashMe()</span></span></span>                                                             </span>
  <span style='color:#555'>    </span>│ <span style='color:#f55'>▲</span>
  <span style='color:#555'>  12</span>│

Press space to interact, D to debug, or any other key to quit (30s)
</pre>

If you run the same program but within a pipeline (so, not attached to
a terminal), you'll instead see a report like this:

```
*** Program crashed: Bad pointer dereference at 0x0000000000000004 ***

Thread 0 crashed:

0               0x00000001045a3df0 reallyCrashMe() + 404 in crash at /Users/alastair/Source/crashDotSwift/crash.swift:4:15
1 [ra]          0x00000001045a3ea4 crashMe() + 12 in crash at /Users/alastair/Source/crashDotSwift/crash.swift:8:3
2 [ra]          0x00000001045a3c50 main + 12 in crash at /Users/alastair/Source/crashDotSwift/crash.swift:11:1
3 [ra] [system] 0x000000018705d058 start + 2224 in dyld


Registers:

 x0 0x0000000000000001  1
 x1 0x0000000000000000  0
 x2 0x0000000000000000  0
 x3 0x000060000016c1c0  c0 c1 28 fd 79 96 00 00 fb 07 00 00 00 00 00 00  ÀÁ(ýy···û·······
 x4 0x000000016b85f098  80 c1 16 00 00 60 00 00 19 00 00 00 00 00 00 00  ·Á···`··········
 x5 0x000000016b85f090  01 00 00 00 00 00 00 00 80 c1 16 00 00 60 00 00  ·········Á···`··
 x6 0x000000000000000a  10
 x7 0x0000000000000000  0
 x8 0x000000000000002a  42
 x9 0x0000000000000004  4
x10 0x0000000000000180  384
x11 0x0000000081a7c008  2175254536
x12 0x00000000000007fb  2043
x13 0x00000000000007fd  2045
x14 0x0000000081c7c807  2177353735
x15 0x0000000000000007  7
x16 0x0000000081a7c008  2175254536
x17 0x000000000007c800  509952
x18 0x0000000000000000  0
x19 0x00000001049bdbd0  68 44 57 e2 01 00 00 00 10 d9 9b 04 01 00 00 00  hDWâ·····Ù······
x20 0x00000001045a3c44  fd 7b bf a9 fd 03 00 91 93 00 00 94 00 00 80 52  ý{¿©ý··········R
x21 0x00000001049bdd38  00 00 00 00 00 00 00 00 20 dd 9b 04 01 00 00 00  ········ Ý······
x22 0x00000001049bd910  00 00 00 00 00 00 00 00 00 00 5a 04 01 00 00 00  ··········Z·····
x23 0x000000016b85f3d0  30 c2 59 e2 01 00 00 00 00 00 00 00 00 00 00 00  0ÂYâ············
x24 0x000000016b85f410  50 f3 85 6b 01 00 00 00 30 80 5b 04 01 00 00 00  Pó·k····0·[·····
x25 0x00000001870dbb1b  2f 75 73 72 2f 6c 69 62 2f 64 79 6c 64 00 5f 5f  /usr/lib/dyld·__
x26 0x0000000000000000  0
x27 0x0000000000000000  0
x28 0x0000000000000000  0
 fp 0x000000016b85f310  20 f3 85 6b 01 00 00 00 a4 3e 5a 04 01 00 00 00   ó·k····¤>Z·····
 lr 0x72268001045a3d44  8225402511295135044
 sp 0x000000016b85f280  a0 f2 85 6b 01 00 00 00 00 00 00 00 00 00 00 00   ò·k············
 pc 0x00000001045a3df0  28 01 00 f9 fd 7b 49 a9 ff 83 02 91 c0 03 5f d6  (··ùý{I©ÿ···À·_Ö


Images (42 omitted):

0x00000001045a0000–0x00000001045a4000 6776aba03ad432b68bc57220ac4e6ef8 crash /Users/alastair/Source/crashDotSwift/crash
0x0000000187057000–0x00000001870ea874 ee3f4181cec538c2b8a84d310be33491 dyld  /usr/lib/dyld
```

### Interactive backtraces

You might be wondering about the message on the last line of the
in-terminal backtrace above, where it says

```
Press space to interact, D to debug, or any other key to quit (30s)
```

Often when developing a program at the terminal, you might find that
the program crashes, but you aren't able to reproduce the problem, and
if you also don't have a suitable crash log, that can be really very
annoying --- you know your program has a bug, but you don't know what
it was or how to reproduce it.

The idea behind this feature is that it leaves the program suspended
(by default for 30 seconds, but this is configurable) and provides you
with the opportunity to either attach a debugger, or to do some
limited additional inspection of the crashed process.

If you tap the spacebar when this prompt appears, you will be
presented with a simple command prompt that allows you to change the
backtracer's settings, generate a new backtrace, list loaded images,
display register and memory contents and get a listing of all of the
threads in the process.  Typing `help` at the prompt will bring up a
list of the available commands:

<pre class="terminal" style="color:#fff; background:#000">
<span style='color:#555'>&gt;&gt;&gt; </span>help
Available commands:

backtrace  Display a backtrace.
bt         Synonym for backtrace.
debug      Attach the debugger.
exit       Exit interaction, allowing program to crash normally.
help       Display help.
images     List images loaded by the program.
mem        Synonym for memory.
memory     Inspect memory.
process    Show information about the process.
quit       Synonym for exit.
reg        Synonym for registers.
registers  Display the registers.
set        Set or show options.
thread     Show or set the current thread.
threads    Synonym for process.
</pre>

If you use the `debug` command or press `D` at the prompt, the
backtracer will help you to attach a debugger to your program.
Exactly what happens here is platform dependent.

If you press any other key, or if the 30 second timer runs down, the
program will be allowed to crash normally.

### Other neat features

You can configure the maximum number of frames that the backtracer
will generate (the default is 64), but since you might also want to
see frames at the top of the stack, the backtracer also has a setting
for the number of frames to capture there (by default 16).  This is
particularly handy if your program crashes due to excessive recursion,
as you'll usually see both the recursion and the cause of it, without
being overwhelmed by thousands and thousands of frames.

The backtracer also skips over system frames and Swift thunks by
default.  These are usually not relevant except to compiler or runtime
engineers, and generally result in more confusing output for ordinary
Swift developers.

Additionally, the backtracer will automatically demangle both Swift
and C++ mangled names.

Finally, the backtracer knows about Swift runtime failures; for
example:

<pre class="terminal" style="color:#fff; background:#000">
<span class='shell'>$ </span><span class='cmd'>./overflow</span>

💣 <span style='color:#f55'>Swift runtime failure: arithmetic overflow</span>

Thread 0 crashed:

<span style='color:#555'>0</span> <span style='color:#5ff'>overflow()</span><span style='color:#aaa'> + 324</span> in <span style='color:#a0a'>overflow</span> at <span style='color:#a60'>/Users/alastair/Source/crashDotSwift/overflow.swift:4:5</span>

  <span style='color:#555'>   2</span>│ 
  <span style='color:#555'>   3</span>│ func overflow() {
  <span style='background:#1c1c1c'><span style='color:#fff'><span style='color:#555'>   4<span style='color:#fff'>│   x -= 1</span></span></span>                                                              </span>
  <span style='color:#555'>    </span>│     <span style='color:#f55'>▲</span>
  <span style='color:#555'>   5</span>│   print(x)
  <span style='color:#555'>   6</span>│ }

<span style='color:#555'>1</span> <span style='color:#5ff'>main</span><span style='color:#aaa'> + 20</span> in <span style='color:#a0a'>overflow</span> at <span style='color:#a60'>/Users/alastair/Source/crashDotSwift/overflow.swift:8:1</span>

  <span style='color:#555'>   6</span>│ }
  <span style='color:#555'>   7</span>│ 
  <span style='background:#1c1c1c'><span style='color:#fff'><span style='color:#555'>   8<span style='color:#fff'>│ overflow()</span></span></span>                                                            </span>
  <span style='color:#555'>    </span>│ <span style='color:#f55'>▲</span>
  <span style='color:#555'>   9</span>│

Press space to interact, D to debug, or any other key to quit (30s)
</pre>

### Backtracer settings

The backtracer is fairly sophisticated and has a number of settings
that you can use to control its output and operation.  You can find
[documentation for the settings in the Swift
repository](https://github.com/apple/swift/blob/main/docs/Backtracing.rst),
in the docs directory.

### Platform support

There is no support presently on Windows, but it is our intention that
the backtracer will eventually work on the Windows platform.

The backtracer is enabled by default on Linux; if you wish to disable
it for some reason, you can do so by setting the `SWIFT_BACKTRACE`
environment variable to `enable=no`.

The backtracer is also available on macOS, but there it is switched
off by default.  You can enable it by setting `SWIFT_BACKTRACE` to
`enable=yes`, which is sufficient if you build your programs using
Xcode.  If you are using some other build tool to build your program,
you will need to sign the program with the entitlement
`com.apple.security.get-task-allow` in order for the backtracer to
work.  This is the same entitlement you would need to make various
other tools work on your program, so you may already be doing this.
If not, you will need to make a property list file containing the
entitlements you wish to sign your program with, e.g.

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>com.apple.security.get-task-allow</key>
<true/>
</dict>
</plist>
```

and then to sign your program you should do

```
$ codesign --force --sign - --entitlements entitlements.plist \
    /path/to/your/program
```

Note that programs with the `com.apple.security.get-task-allow`
entitlement will not be accepted for distribution in the App Store,
and will be rejected by notarization.  The entitlement is strictly for
debugging purposes only and software should not be shipped to end
users with it enabled.

The backtracer is not supported on iOS, tvOS or other Darwin
derivatives.

### Implementation notes

If you are building Docker images yourself and want to take advantage
of this feature, you will need to ensure that you include the
`libexec` directory from the Swift installation in your image.  The
backtracer runs out-of-process, and lives in that directory by
default (it locates itself relative to the Swift runtime).  If the
runtime can't find the backtracer, you won't get backtraces, and
things will crash just as before.
